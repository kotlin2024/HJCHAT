<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WebSocket Chat</title>
    <style>
        body {
            font-family: Arial, sans-serif;
        }

        #chatBox {
            width: 400px;
            height: 300px;
            border: 1px solid #ccc;
            margin: 20px 0;
            padding: 10px;
            overflow-y: auto;
        }

        #inputMessage {
            width: 100%;
            padding: 10px;
            margin-top: 10px;
        }

        #chatRooms {
            margin: 20px 0;
        }

        #createRoomBtn {
            margin-top: 10px;
        }
    </style>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/stomp.js/2.3.3/stomp.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sockjs-client@1/dist/sockjs.min.js"></script>
</head>
<body>

<h1>HJ Chat</h1>

<!-- 로그인 섹션 -->
<div id="loginSection">
    <h2>Login</h2>
    <input type="text" id="username" placeholder="Username" required />
    <input type="password" id="password" placeholder="Password" required />
    <button onclick="login()">Login</button>
</div>

<!-- 채팅 섹션 -->
<div id="chatSection" style="display: none;">
    <h2>Chat Room</h2>
    <div id="chatRooms">
        <h3>Available Chat Rooms</h3>
        <div id="roomList"></div>
        <button id="createRoomBtn" onclick="showCreateRoomModal()">Create Chat Room</button>
    </div>

    <div id="chatBox"></div>
    <input type="text" id="inputMessage" placeholder="Type a message..." />
    <button onclick="sendMessage()">Send</button>
</div>

<!-- 채팅방 생성 섹션 -->
<div id="createRoomSection" style="display: none;">
    <h3>Create Chat Room</h3>
    <input type="text" id="roomName" placeholder="Enter room name" />
    <div>
        <label>
            <input type="radio" name="roomType" value="PUBLIC" checked /> Public
        </label>
        <label>
            <input type="radio" name="roomType" value="PRIVATE" /> Private
        </label>
    </div>
    <button onclick="createChatRoom()">Create</button>
    <button onclick="hideCreateRoomModal()">Cancel</button>
</div>

<script>
    let ws = null; // WebSocket 객체 전역 선언
    let accessToken = ''; // AccessToken 저장
    let currentChatRoomId = null; // 현재 채팅방 ID

    // 로그인 함수
    function login() {
        const username = document.getElementById('username').value;
        const password = document.getElementById('password').value;

        fetch('http://localhost:8080/api/oauth/login', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({ username, password }),
        })
            .then(response => {
                if (!response.ok) {
                    throw new Error(`로그인 실패: 서버 응답 상태 ${response.status}`);
                }

                const token = response.headers.get('Authorization')?.split(' ')[1];
                if (!token) {
                    throw new Error('로그인 실패: Authorization 헤더가 비어있음');
                }

                accessToken = token;

                document.getElementById('loginSection').style.display = 'none';
                document.getElementById('chatSection').style.display = 'block';

                initializeWebSocket();
                loadChatRooms();
            })
            .catch(error => {
                console.error('로그인 실패:', error);
                alert(error.message);
            });
    }

    // WebSocket 초기화
    function initializeWebSocket() {
        const socket = new SockJS(`http://localhost:8080/ws?token=${accessToken}`);
        ws = Stomp.over(socket);

        ws.connect({}, function (frame) {
            console.log("WebSocket 연결 성공:", frame);

            if (currentChatRoomId) {
                ws.subscribe(`/topic/chatroom/${currentChatRoomId}`, function (message) {
                    const receivedMessage = JSON.parse(message.body);
                    displayMessage(receivedMessage);
                });
            }
        }, function (error) {
            console.error("WebSocket 연결 실패:", error);
            alert("WebSocket 연결 실패");
        });
    }

    // 채팅방 목록 로드
    function loadChatRooms() {
        fetch('http://localhost:8080/graphql', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${accessToken}`
            },
            body: JSON.stringify({
                query: `query {
                    getChatRooms {
                        id
                        roomName
                        roomType
                    }
                }`
            })
        })
            .then(response => response.json())
            .then(data => {
                const roomList = document.getElementById('roomList');
                roomList.innerHTML = '';
                const rooms = data.data.getChatRooms;

                rooms.forEach(room => {
                    const roomElement = document.createElement('div');
                    roomElement.innerHTML = `
                        <button onclick="joinChatRoom(${room.id}, '${room.roomName}')">${room.roomName} (${room.roomType})</button>
                    `;
                    roomList.appendChild(roomElement);
                });
            })
            .catch(error => {
                console.error('채팅방 목록 로드 실패:', error);
                alert('채팅방 목록 로드 실패: ' + error.message);
            });
    }

    // 채팅방 입장
    function joinChatRoom(roomId, roomName) {
        currentChatRoomId = roomId;

        alert(`"${roomName}" 채팅방에 입장했습니다.`);
        document.getElementById('chatBox').innerHTML = '';

        if (ws) {
            ws.subscribe(`/topic/chatroom/${roomId}`, function (message) {
                const receivedMessage = JSON.parse(message.body);
                displayMessage(receivedMessage);
            });
        }
    }

    // 채팅방 생성
    function createChatRoom() {
        const roomName = document.getElementById('roomName').value;
        const roomType = document.querySelector('input[name="roomType"]:checked').value;

        if (!roomName || !roomType) {
            alert('Please provide a room name and select a room type.');
            return;
        }

        fetch('http://localhost:8080/graphql', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${accessToken}`
            },
            body: JSON.stringify({
                query: `mutation {
                    createChatRoom(roomName: "${roomName}", roomType: "${roomType}") {
                        id
                        roomName
                        roomType
                    }
                }`
            })
        })
            .then(response => response.json())
            .then(data => {
                const chatRoom = data.data.createChatRoom;
                alert(`Chat room "${chatRoom.roomName}" created as ${chatRoom.roomType.toLowerCase()}!`);
                hideCreateRoomModal();
                loadChatRooms();
            })
            .catch(error => {
                console.error('Chat room creation failed:', error);
                alert('Chat room creation failed: ' + error.message);
            });
    }

    function showCreateRoomModal() {
        document.getElementById('createRoomSection').style.display = 'block';
    }

    function hideCreateRoomModal() {
        document.getElementById('createRoomSection').style.display = 'none';
    }

    // 메시지 전송
    function sendMessage() {
        const messageContent = document.getElementById('inputMessage').value; // 입력된 메시지
        console.log("Message content:", messageContent);
        console.log("Current Chat Room ID:", currentChatRoomId);
        console.log("WebSocket status:", ws ? "Connected" : "Not Connected");

        if (messageContent.trim() && currentChatRoomId && ws) {
            const message = {
                chatRoomId: currentChatRoomId,
                content: messageContent,
                senderName: localStorage.getItem('userName') || "Unknown"
            };

            ws.send(`/app/send`, {}, JSON.stringify(message)); // 메시지 전송
            document.getElementById('inputMessage').value = ''; // 입력 필드 초기화
        } else {
            if (!messageContent.trim()) {
                alert('메시지를 입력해주세요.');
            } else if (!currentChatRoomId) {
                alert('채팅방을 선택해주세요.');
            } else if (!ws) {
                alert('WebSocket이 연결되지 않았습니다.');
            }
        }
    }



    // 메시지 표시
    function displayMessage(message) {
        const chatBox = document.getElementById('chatBox');
        const messageElement = document.createElement('div');
        messageElement.innerHTML = `<strong>${message.senderName}:</strong> ${message.content}`;
        chatBox.appendChild(messageElement);
        chatBox.scrollTop = chatBox.scrollHeight;
    }
</script>

</body>
</html>
